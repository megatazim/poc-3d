define(["./defaultValue-6195d6e4","./Ellipsoid-9d24693d","./ArcType-198c1070","./arrayFill-6162b951","./BoundingRectangle-330469e1","./buildModuleUrl-89a61082","./Cartesian3-6ab6e817","./Cartographic-84b54204","./Check-d771f3f9","./ComponentDatatype-9e683007","./EllipsoidGeodesic-4e69d466","./EllipsoidTangentPlane-f8d45d42","./GeometryAttribute-b7129781","./GeometryInstance-2e0c38c0","./GeometryOffsetAttribute-da5a1d35","./GeometryPipeline-e9b54c6d","./IndexDatatype-7f829734","./Math-77022010","./FeatureDetection-d5e675a3","./PolygonGeometryLibrary-6924f62a","./PolygonPipeline-5d307ca1","./Rectangle-f1a1bbf0","./VertexFormat-8dc15345","./PrimitiveType-5db31a9b","./Cartesian4-da892aa1","./RuntimeError-3afc2b48","./WebGLConstants-92042d9e","./defer-a21481c0","./Event-8b63693e","./IntersectionTests-0125ff6b","./Plane-588042d8","./AttributeCompression-f1ba21d8","./EncodedCartesian3-aa410950","./arrayRemoveDuplicates-a80848e1","./EllipsoidRhumbLine-7f7a0363","./GeometryAttributes-bc1c2f3f"],(function(t,e,o,r,i,a,n,s,l,u,p,c,g,d,h,y,m,f,v,_,b,w,T,I,A,P,x,E,O,H,D,N,C,L,R,F){"use strict";var G=new s.a,B=new s.a;function S(t,e,o,r){var i=r.cartesianToCartographic(t,G).height,a=r.cartesianToCartographic(e,B);a.height=i,r.cartographicToCartesian(a,e);var n=r.cartesianToCartographic(o,B);n.height=i-100,r.cartographicToCartesian(n,o)}var V=new i.f,k=new n.o,z=new n.o,M=new n.o,U=new n.o,W=new n.o,Y=new n.o,j=new n.o,q=new n.o,K=new n.o,Q=new e.o,Z=new e.o,J=new n.o,X=new g.n,$=new v.p,tt=new v.p;function et(o){var i=o.vertexFormat,a=o.geometry,s=o.shadowVolume,l=a.attributes.position.values,p=l.length,c=o.wall,d=o.top||c,y=o.bottom||c;if(i.st||i.normal||i.tangent||i.bitangent||s){var m=o.boundingRectangle,_=o.tangentPlane,b=o.ellipsoid,w=o.stRotation,T=o.perPositionHeight,I=Q;I.x=m.x,I.y=m.y;var A,P=o.isComputeTexCoord?new Float32Array(p):new Float32Array(p/3*2),x=i.st?P:void 0;i.normal&&(A=T&&d&&!c?a.attributes.normal.values:new Float32Array(p));var E=i.tangent?new Float32Array(p):void 0,O=i.bitangent?new Float32Array(p):void 0,H=s?new Float32Array(p):void 0,D=0,N=0,C=z,L=M,R=U,F=!0,G=$,B=tt;if(0!==w){var V=g.n.fromAxisAngle(_._plane.normal,w,X);G=v.p.fromQuaternion(V,G),V=g.n.fromAxisAngle(_._plane.normal,-w,X),B=v.p.fromQuaternion(V,B)}else G=v.p.clone(v.p.IDENTITY,G),B=v.p.clone(v.p.IDENTITY,B);var et=0,ot=0;d&&y&&(et=p/2,ot=p/3,p/=2);for(var rt=0;rt<p;rt+=3){var it=n.o.fromArray(l,rt,J);if(i.st){var at=v.p.multiplyByVector(G,it,k);at=b.scaleToGeodeticSurface(at,at);var nt=_.projectPointOntoPlane(at,Z);e.o.subtract(nt,I,nt);var st=f.e.clamp(nt.x/m.width,0,1),lt=f.e.clamp(nt.y/m.height,0,1);y&&(x[D+ot]=st,x[D+1+ot]=lt),d&&(x[D]=st,x[D+1]=lt),D+=2}if(i.normal||i.tangent||i.bitangent||s){var ut=N+1,pt=N+2;if(c){if(rt+3<p){var ct=n.o.fromArray(l,rt+3,W);if(F){var gt=n.o.fromArray(l,rt+p,Y);T&&S(it,ct,gt,b),n.o.subtract(ct,it,ct),n.o.subtract(gt,it,gt),C=n.o.normalize(n.o.cross(gt,ct,C),C),F=!1}n.o.equalsEpsilon(ct,it,f.e.EPSILON10)&&(F=!0)}(i.tangent||i.bitangent)&&(R=b.geodeticSurfaceNormal(it,R),i.tangent&&(L=n.o.normalize(n.o.cross(R,C,L),L)))}else C=b.geodeticSurfaceNormal(it,C),(i.tangent||i.bitangent)&&(T&&(j=n.o.fromArray(A,N,j),q=n.o.cross(n.o.UNIT_Z,j,q),q=n.o.normalize(v.p.multiplyByVector(B,q,q),q),i.bitangent&&(K=n.o.normalize(n.o.cross(j,q,K),K))),L=n.o.cross(n.o.UNIT_Z,C,L),L=n.o.normalize(v.p.multiplyByVector(B,L,L),L),i.bitangent&&(R=n.o.normalize(n.o.cross(C,L,R),R)));i.normal&&(o.wall?(A[N+et]=C.x,A[ut+et]=C.y,A[pt+et]=C.z):y&&(A[N+et]=-C.x,A[ut+et]=-C.y,A[pt+et]=-C.z),(d&&!T||c)&&(A[N]=C.x,A[ut]=C.y,A[pt]=C.z)),s&&(c&&(C=b.geodeticSurfaceNormal(it,C)),H[N+et]=-C.x,H[ut+et]=-C.y,H[pt+et]=-C.z),i.tangent&&(o.wall?(E[N+et]=L.x,E[ut+et]=L.y,E[pt+et]=L.z):y&&(E[N+et]=-L.x,E[ut+et]=-L.y,E[pt+et]=-L.z),d&&(T?(E[N]=q.x,E[ut]=q.y,E[pt]=q.z):(E[N]=L.x,E[ut]=L.y,E[pt]=L.z))),i.bitangent&&(y&&(O[N+et]=R.x,O[ut+et]=R.y,O[pt+et]=R.z),d&&(T?(O[N]=K.x,O[ut]=K.y,O[pt]=K.z):(O[N]=R.x,O[ut]=R.y,O[pt]=R.z))),N+=3}}i.st&&(a.attributes.st=new g.o({componentDatatype:u.ComponentDatatype.FLOAT,componentsPerAttribute:2,values:x})),i.normal&&(a.attributes.normal=new g.o({componentDatatype:u.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:A})),i.tangent&&(a.attributes.tangent=new g.o({componentDatatype:u.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:E})),i.bitangent&&(a.attributes.bitangent=new g.o({componentDatatype:u.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:O})),s&&(a.attributes.extrudeDirection=new g.o({componentDatatype:u.ComponentDatatype.FLOAT,componentsPerAttribute:3,values:H}))}if(o.extrude&&t.e(o.offsetAttribute)){var dt=l.length/3,ht=new Uint8Array(dt);if(o.offsetAttribute===h.z.TOP)d&&y||c?ht=r.d(ht,1,0,dt/2):d&&(ht=r.d(ht,1));else{var yt=o.offsetAttribute===h.z.NONE?0:1;ht=r.d(ht,yt)}a.attributes.applyOffset=new g.o({componentDatatype:u.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:ht})}return a}var ot=new s.a,rt=new s.a;const it={westOverIDL:0,eastOverIDL:0};var at=new p.E;function nt(e,r,i,a,n){if(n=t.u(n,new w.h),!t.e(e)||e.length<3)return n.west=0,n.north=0,n.south=0,n.east=0,n;if(i===o.L.RHUMB)return w.h.fromCartesianArray(e,r,n);at.ellipsoid.equals(r)||(at=new p.E(void 0,void 0,r)),n.west=Number.POSITIVE_INFINITY,n.east=Number.NEGATIVE_INFINITY,n.south=Number.POSITIVE_INFINITY,n.north=Number.NEGATIVE_INFINITY,it.westOverIDL=Number.POSITIVE_INFINITY,it.eastOverIDL=Number.NEGATIVE_INFINITY;for(var s,l=1/f.e.chordLength(a,r.maximumRadius),u=e.length,c=r.cartesianToCartographic(e[0],rt),g=ot,d=1;d<u;d++)s=g,g=c,c=r.cartesianToCartographic(e[d],s),at.setEndPoints(g,c),lt(at,l,n,it);return s=g,g=c,c=r.cartesianToCartographic(e[0],s),at.setEndPoints(g,c),lt(at,l,n,it),n.east-n.west>it.eastOverIDL-it.westOverIDL&&(n.west=it.westOverIDL,n.east=it.eastOverIDL,n.east>f.e.PI&&(n.east=n.east-f.e.TWO_PI),n.west>f.e.PI&&(n.west=n.west-f.e.TWO_PI)),n}var st=new s.a;function lt(t,e,o,r){for(var i=t.surfaceDistance,a=Math.ceil(i*e),n=a>0?i/(a-1):Number.POSITIVE_INFINITY,s=0,l=0;l<a;l++){var u=t.interpolateUsingSurfaceDistance(s,st);s+=n;var p=u.longitude,c=u.latitude;o.west=Math.min(o.west,p),o.east=Math.max(o.east,p),o.south=Math.min(o.south,c),o.north=Math.max(o.north,c);const e=p>=0?p:p+f.e.TWO_PI;r.westOverIDL=Math.min(r.westOverIDL,e),r.eastOverIDL=Math.max(r.eastOverIDL,e)}}var ut=[];function pt(t,e,o,r,i,a,n,s,l,u){var p,g={walls:[]};if(a||n){var h,y,f=_.l.createGeometryFromPositions(t,e,o,i,s,l),v=f.attributes.position.values,w=f.indices;if(a&&n){var T=v.concat(v);h=T.length/3,(y=m.IndexDatatype.createTypedArray(h,2*w.length)).set(w);var I=w.length,A=h/2;for(p=0;p<I;p+=3){var P=y[p]+A,x=y[p+1]+A,E=y[p+2]+A;y[p+I]=E,y[p+1+I]=x,y[p+2+I]=P}if(f.attributes.position.values=T,i&&s.normal){var O=f.attributes.normal.values;f.attributes.normal.values=new Float32Array(T.length),f.attributes.normal.values.set(O)}f.indices=y}else if(n){for(h=v.length/3,y=m.IndexDatatype.createTypedArray(h,w.length),p=0;p<w.length;p+=3)y[p]=w[p+2],y[p+1]=w[p+1],y[p+2]=w[p];f.indices=y}g.topAndBottom=new d.d({geometry:f})}var H,D=r.outerRing,N=c.f.fromPoints(D,t),C=N.projectPointsOntoPlane(D,ut),L=b.A.computeWindingOrder2D(C);L===b.W.CLOCKWISE&&(D=D.slice().reverse()),u&&(H=_.l.computeWallGeometry(D,t,o,i,l),g.walls.push(new d.d({geometry:H})));var R=r.holes;for(p=0;p<R.length;p++){var F=R[p];C=(N=c.f.fromPoints(F,t)).projectPointsOntoPlane(F,ut),(L=b.A.computeWindingOrder2D(C))===b.W.COUNTER_CLOCKWISE&&(F=F.slice().reverse()),H=_.l.computeWallGeometry(F,t,o,i,l),g.walls.push(new d.d({geometry:H}))}return g}function ct(r){if(l.o.typeOf.object("options",r),l.o.typeOf.object("options.polygonHierarchy",r.polygonHierarchy),t.e(r.perPositionHeight)&&r.perPositionHeight&&t.e(r.height))throw new l.t("Cannot use both options.perPositionHeight and options.height");if(t.e(r.arcType)&&r.arcType!==o.L.GEODESIC&&r.arcType!==o.L.RHUMB)throw new l.t("Invalid arcType. Valid options are ArcType.GEODESIC and ArcType.RHUMB.");var i=r.polygonHierarchy,a=t.u(r.vertexFormat,T.n.DEFAULT),n=t.u(r.ellipsoid,e.t.WGS84),s=t.u(r.granularity,f.e.RADIANS_PER_DEGREE),u=t.u(r.stRotation,0),p=t.u(r.perPositionHeight,!1),c=p&&t.e(r.extrudedHeight),g=t.u(r.height,0),d=t.u(r.extrudedHeight,g);if(!c){var h=Math.max(g,d);d=Math.min(g,d),g=h}this._vertexFormat=T.n.clone(a),this._ellipsoid=e.t.clone(n),this._granularity=s,this._stRotation=u,this._height=g,this._extrudedHeight=d,this._closeTop=t.u(r.closeTop,!0),this._closeBottom=t.u(r.closeBottom,!0),this._extrudeOutering=t.u(r.extrudeOutering,!0),this._polygonHierarchy=i,this._perPositionHeight=p,this._perPositionHeightExtrude=c,this._shadowVolume=t.u(r.shadowVolume,!1),this._workerName="createPolygonGeometry",this._offsetAttribute=r.offsetAttribute,this._arcType=t.u(r.arcType,o.L.GEODESIC),this._groundBottomAltitude=t.u(r.groundBottomAltitude,0),this._groundExtrudedHeight=t.u(r.groundExtrudedHeight,0),this._rectangle=void 0,this._textureCoordinateRotationPoints=void 0,this.packedLength=_.l.computeHierarchyPackedLength(i)+e.t.packedLength+T.n.packedLength+12}ct.fromPositions=function(e){return e=t.u(e,t.u.EMPTY_OBJECT),l.o.defined("options.positions",e.positions),new ct({polygonHierarchy:{positions:e.positions},height:e.height,extrudedHeight:e.extrudedHeight,vertexFormat:e.vertexFormat,stRotation:e.stRotation,ellipsoid:e.ellipsoid,granularity:e.granularity,perPositionHeight:e.perPositionHeight,closeTop:e.closeTop,closeBottom:e.closeBottom,offsetAttribute:e.offsetAttribute,arcType:e.arcType})},ct.pack=function(o,r,i){return l.o.typeOf.object("value",o),l.o.defined("array",r),i=t.u(i,0),i=_.l.packPolygonHierarchy(o._polygonHierarchy,r,i),e.t.pack(o._ellipsoid,r,i),i+=e.t.packedLength,T.n.pack(o._vertexFormat,r,i),i+=T.n.packedLength,r[i++]=o._height,r[i++]=o._extrudedHeight,r[i++]=o._granularity,r[i++]=o._stRotation,r[i++]=o._perPositionHeightExtrude?1:0,r[i++]=o._perPositionHeight?1:0,r[i++]=o._closeTop?1:0,r[i++]=o._closeBottom?1:0,r[i++]=o._shadowVolume?1:0,r[i++]=t.u(o._offsetAttribute,-1),r[i++]=o._arcType,r[i]=o.packedLength,r};var gt=e.t.clone(e.t.UNIT_SPHERE),dt=new T.n,ht={polygonHierarchy:{}};return ct.unpack=function(o,r,i){l.o.defined("array",o),r=t.u(r,0);var a=_.l.unpackPolygonHierarchy(o,r);r=a.startingIndex,delete a.startingIndex;var n=e.t.unpack(o,r,gt);r+=e.t.packedLength;var s=T.n.unpack(o,r,dt);r+=T.n.packedLength;var u=o[r++],p=o[r++],c=o[r++],g=o[r++],d=1===o[r++],h=1===o[r++],y=1===o[r++],m=1===o[r++],f=1===o[r++],v=o[r++],b=o[r++],w=o[r];return t.e(i)||(i=new ct(ht)),i._polygonHierarchy=a,i._ellipsoid=e.t.clone(n,i._ellipsoid),i._vertexFormat=T.n.clone(s,i._vertexFormat),i._height=u,i._extrudedHeight=p,i._granularity=c,i._stRotation=g,i._perPositionHeightExtrude=d,i._perPositionHeight=h,i._closeTop=y,i._closeBottom=m,i._shadowVolume=f,i._offsetAttribute=-1===v?void 0:v,i._arcType=b,i.packedLength=w,i},ct.computeRectangle=function(r,i){l.o.typeOf.object("options",r),l.o.typeOf.object("options.polygonHierarchy",r.polygonHierarchy);var a=t.u(r.granularity,f.e.RADIANS_PER_DEGREE),n=t.u(r.arcType,o.L.GEODESIC);if(n!==o.L.GEODESIC&&n!==o.L.RHUMB)throw new l.t("Invalid arcType. Valid options are ArcType.GEODESIC and ArcType.RHUMB.");var s=r.polygonHierarchy,u=t.u(r.ellipsoid,e.t.WGS84);return nt(s.positions,u,n,a,i)},ct.createGeometry=function(e){var o=e._vertexFormat,i=e._ellipsoid,n=e._granularity,s=e._stRotation,l=e._polygonHierarchy,p=e._perPositionHeight,v=e._closeTop,w=e._closeBottom,T=e._arcType,I=l.positions;if(!(I.length<3)){var A=c.f.fromPoints(I,i),P=_.l.polygonsFromHierarchy(l,A.projectPointsOntoPlane.bind(A),!p,i),x=P.hierarchy,E=P.polygons;if(0!==x.length){I=x[0].outerRing;var O,H=_.l.computeBoundingRectangle(A.plane.normal,A.projectPointOntoPlane.bind(A),I,s,V),D=[],N=e._height,C=e._extrudedHeight,L={perPositionHeight:p,vertexFormat:o,geometry:void 0,tangentPlane:A,boundingRectangle:H,ellipsoid:i,stRotation:s,bottom:!1,top:!0,wall:!1,extrude:!1,arcType:T};if(e._perPositionHeightExtrude||!f.e.equalsEpsilon(N,C,0,f.e.EPSILON2))for(L.extrude=!0,L.top=v,L.bottom=w,L.shadowVolume=e._shadowVolume,L.offsetAttribute=e._offsetAttribute,O=0;O<E.length;O++){var R,F=pt(i,E[O],n,x[O],p,v,w,o,T,e._extrudeOutering);v&&w?(R=F.topAndBottom,L.geometry=_.l.scaleToGeodeticHeightExtruded(R.geometry,N,C,i,p)):v?((R=F.topAndBottom).geometry.attributes.position.values=b.A.scaleToGeodeticHeight(R.geometry.attributes.position.values,N,i,!p),L.geometry=R.geometry):w&&((R=F.topAndBottom).geometry.attributes.position.values=b.A.scaleToGeodeticHeight(R.geometry.attributes.position.values,C,i,!0),L.geometry=R.geometry),(v||w)&&(L.wall=!1,R.geometry=et(L),D.push(R));var G=F.walls;L.wall=!0;for(var B=0;B<G.length;B++){var S=G[B];L.geometry=_.l.scaleToGeodeticHeightExtruded(S.geometry,N,C,i,p),S.geometry=et(L),D.push(S)}}else for(O=0;O<E.length;O++){var k=new d.d({geometry:_.l.createGeometryFromPositions(i,E[O],n,p,o,T)});if(k.geometry.attributes.position.values=b.A.scaleToGeodeticHeight(k.geometry.attributes.position.values,N,i,!p),L.geometry=k.geometry,k.geometry=et(L),t.e(e._offsetAttribute)){var z=k.geometry.attributes.position.values.length,M=new Uint8Array(z/3),U=e._offsetAttribute===h.z.NONE?0:1;r.d(M,U),k.geometry.attributes.applyOffset=new g.o({componentDatatype:u.ComponentDatatype.UNSIGNED_BYTE,componentsPerAttribute:1,values:M})}D.push(k)}var W=y.k.combineInstances(D)[0];W.attributes.position.values=new Float64Array(W.attributes.position.values),W.indices=m.IndexDatatype.createTypedArray(W.attributes.position.values.length/3,W.indices);var Y=W.attributes,j=a.i.fromVertices(Y.position.values);return o.position||delete Y.position,new g.I({attributes:Y,indices:W.indices,primitiveType:W.primitiveType,boundingSphere:j,offsetAttribute:e._offsetAttribute})}}},ct.createShadowVolume=function(t,e,o){var r=t._granularity,i=t._ellipsoid,a=t._groundBottomAltitude+t._groundExtrudedHeight,n=t._groundBottomAltitude?t._groundBottomAltitude:e(r,i),s=a!==t._groundBottomAltitude?a:o(r,i);return new ct({polygonHierarchy:t._polygonHierarchy,ellipsoid:i,stRotation:t._stRotation,granularity:r,perPositionHeight:!1,extrudedHeight:n,height:s,vertexFormat:T.n.POSITION_ONLY,shadowVolume:!t._groundBottomAltitude,arcType:t._arcType})},Object.defineProperties(ct.prototype,{rectangle:{get:function(){if(!t.e(this._rectangle)){var e=this._polygonHierarchy.positions;this._rectangle=nt(e,this._ellipsoid,this._arcType,this._granularity)}return this._rectangle}},textureCoordinateRotationPoints:{get:function(){return t.e(this._textureCoordinateRotationPoints)||(this._textureCoordinateRotationPoints=function(t){var e=-t._stRotation;if(0===e)return[0,0,0,1,1,0];var o=t._ellipsoid,r=t._polygonHierarchy.positions,i=t.rectangle;return g.I._textureCoordinateRotationPoints(r,e,o,i)}(this)),this._textureCoordinateRotationPoints}}}),function(o,r){return t.e(r)&&(o=ct.unpack(o,r)),o._ellipsoid=e.t.clone(o._ellipsoid),ct.createGeometry(o)}}));
